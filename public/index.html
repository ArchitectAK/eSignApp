<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Signature Pad and PDF Operations</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <h2>Signature Pad</h2>
    <canvas id="signature-pad" width="400" height="200"></canvas>
    <button id="clear">Clear</button>
    <button id="apply-signature">Apply Signature</button>
    
    <h2>Upload PDF</h2>
    <input type="file" id="upload-pdf" accept="application/pdf">
    <button id="download-pdf">Download PDF</button>
    <div id="qrcode"></div>

    <script>
        const serverURL = 'http://localhost:3000'; // Ensure this matches your server URL
        let sessionID = generateSessionID();
        let ws;
        let isDrawing = false;

        const canvas = document.getElementById('signature-pad');
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = '#000000'; // Default black color for the signature

        setupWebSocket(sessionID);
        setupCanvasEventListeners();
        setupButtonEventListeners();

        function setupWebSocket(sessionID) {
            ws = new WebSocket(`ws://localhost:3000?sessionId=${sessionID}`);
            ws.onmessage = (event) => {
                const signatureData = JSON.parse(event.data);
                if (signatureData.clear) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                } else {
                    drawSignature(signatureData);
                }
            };
        }

        function setupCanvasEventListeners() {
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchcancel', stopDrawing);
        }

        function setupButtonEventListeners() {
            document.getElementById('clear').addEventListener('click', clearCanvas);
            document.getElementById('upload-pdf').addEventListener('change', uploadPDF);
            document.getElementById('apply-signature').addEventListener('click', applySignature);
            document.getElementById('download-pdf').addEventListener('click', downloadPDF);
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getPosition(e);
            drawSignature({ ...pos, moveTo: true });
            sendSignatureData({ ...pos, moveTo: true });
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getPosition(e);
            drawSignature(pos);
            sendSignatureData(pos);
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            isDrawing = false;
            sendSignatureData({ clear: true });
        }

        function getPosition(event) {
            const rect = canvas.getBoundingClientRect();
            const { clientX, clientY } = event.touches ? event.touches[0] : event;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function sendSignatureData(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            }
        }

        function drawSignature({ x, y, moveTo }) {
            if (moveTo) {
                ctx.beginPath();
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
                ctx.stroke();
            }
        }

        async function uploadPDF(e) {
            const file = e.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('sessionID', sessionID);

                const response = await fetch(`${serverURL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    generateQRCode(generateSessionURL(sessionID));
                } else {
                    alert('Failed to upload PDF');
                }
            }
        }

        async function applySignature() {
            const signatureData = canvas.toDataURL('image/png');
            const response = await fetch(`${serverURL}/apply-signature`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionID, signatureData })
            });

            if (response.ok) {
                alert('Your signature has been applied.');
            } else {
                alert('Failed to apply signature');
            }
        }

        async function downloadPDF() {
            try {
                const response = await fetch(`${serverURL}/download?sessionID=${sessionID}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'signed_document.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    const errorText = await response.text();
                    alert(`Failed to download PDF: ${errorText}`);
                }
            } catch (error) {
                alert(`Error occurred: ${error.message}`);
            }
        }

        function generateSessionID() {
            return Math.random().toString(36).substring(2);
        }

        function generateSessionURL(sessionID) {
            return `${window.location.origin}${window.location.pathname}?sessionId=${sessionID}`;
        }

        function generateQRCode(url) {
            const qrCodeContainer = document.getElementById('qrcode');
            qrCodeContainer.innerHTML = ''; // Clear existing QR code
            new QRCode(qrCodeContainer, {
                text: url,
                width: 128,
                height: 128
            });
        }

        // Check if there is a session ID in the URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('sessionId')) {
            sessionID = urlParams.get('sessionId');
            document.getElementById('qrcode').style.display = 'none';
            setupWebSocket(sessionID);
        }
    </script>
</body>
</html>